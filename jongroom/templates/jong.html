{% load static %}
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title></title>
<meta charset="utf-8">
<meta name="description" content="">
<meta name="author" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="">
<link rel="stylesheet" type="text/css" href="{% static 'jongroom/css/medium.css' %}" />

<script src="{% static 'jongroom/js/vue.js' %}"></script>
<script src="{% static 'jongroom/js/utils.js' %}"></script>
<script src="{% static 'jongroom/js/jong_network.js' %}"></script>
<script>
Vue.config.delimiters = ['$${', '}'];
function numtosrc(x){ if( x in Deck.numtosrc_table ){ return "{% static 'jongroom/images30_22/'%}" + Deck.numtosrc_table[x]+".png"; }else{ return ""; } }

function __img(x){ return '<img src="{% static 'jongroom/images30_22/'%}'+x+'.png" >';}

</script>
</head>
<body>
<audio id="sound1" preload="auto">
  <source src="{% static 'jongroom/sound/puu79_a.wav' %}" type="audio/wav">
</audio>
<audio id="sound_dapai" control preload="auto">
  <source src="{% static 'jongroom/sound/clock04.wav' %}" type="audio/wav">
</audio>
<div id="board-root" class="clearfix">
  <div id="info">
    <p>ノコリ：$${ deck_left }</p>
    <p> $${ get_wind_name( prev_wind ) }場 $${ get_wind_name(seat_wind) }風 </p>
    <p v-if="time_left!=null">入力待機 残り：$${ time_left.toFixed(1) }秒</p>
    <p>$${ message }</p>
  </div>
  <player-area id="hand1" v-bind:player="players[1]" class="player-field"></player-area>
  <player-area id="hand2" v-bind:player="players[2]" class="player-field"></player-area>
  <player-area id="hand3" v-bind:player="players[3]" class="player-field"></player-area>
  <player-area id="hand0" v-bind:player="players[0]" main=1 class="player-field"></player-area>
</div>
<!--
<div id="sideinfo">
  <table>
    <tr v-for="(y,i) in list">
      <td>$${y.title}</td>
      <td>$${y.score}</td>
    </tr>
  </table>
  <p style="">計 : $${score}</p>
</div>
-->
<div id="meld-select">
  <transition name="meld-select">
    <div v-if="meld_selection.length > 0" class="meld-select-box">
      <div v-for="(grp,index) in meld_selection" class="exposed-group group-clickable" v-bind:pos="index" onclick="click_meld_popup(this.getAttribute('pos'));">
        <div v-for="(item,jndex) in grp" class="exposed-item tile">
          <img v-bind:src="numtosrc(item)" >
        </div>
      </div>
    </div>
  </transition>
</div>

<script>

var deck = new Deck();

function __last_target(t){
  return deck.last_target == t;
}


Vue.component('player-area', {
  props : ["player","main"],
  data: function(){return {};} ,
  template: `
  <div>
    <trash-tile v-bind:trash="player.trash" v-bind:target="player.target=='trash'"></trash-tile>
    <div v-if="main" class="command-bar clearfix" style="width:100%;height:24px;">
      <transition-group class="command-bar clearfix" name="command">
        <div id="chow" key="chow" v-if="player.command_types_available.has('chow')" class="command" onclick="command('chow');">チー(Z)</div>
        <div id="pong" key="pong" v-if="player.command_types_available.has('pong')" class="command" onclick="command('pong');">ポン(X)</div>
        <div id="kong" key="kong" v-if="player.command_types_available.has('kong')" class="command" onclick="command('kong');">カン(C)</div>
        <div id="conckong" key="conckong" v-if="player.command_types_available.has('conckong')" class="command" onclick="command('conckong');">暗カン</div>
        <div id="apkong" key="apkong" v-if="player.command_types_available.has('apkong')" class="command" onclick="command('apkong');">加カン</div>
        <div id="ron" key="ron" v-if="player.command_types_available.has('ron')" class="command" onclick="command('ron');">ロン</div>
        <div id="tsumo" key="tsumo" v-if="player.command_types_available.has('tsumo')" class="command" onclick="command('tsumo');">ツモ</div>
        <div id="skip" key="skip" v-if="player.command_types_available.has('skip')" class="command" onclick="command('skip');">スキップ</div>
      </transition-group>
    </div>
    <table v-bind:class="{'border-discard-hand':player.allow_discard}">
      <tr>
      <td v-for="(item,index) in player.hand">
        <span v-bind:pos="index" onClick="tile_click(this);" >
            <img v-bind:src="numtosrc(item)" >
        </span>
      </td>
      <td width='20'></td>
      <td v-if="player.drawed != null" pos="-1" onClick="tile_click(this);" >
        <img v-bind:src="numtosrc(player.drawed)" >
      </td>
      </tr>
    </table>
    <pullout-tile v-bind:pullout="player.pullout"></pullout-tile>
    <exposed-tile v-bind:exposed="player.exposed" v-bind:target="player.target=='apkong'"></exposed-tile>
  </div>
  `,
  methods:{
    numtosrc:numtosrc
  }
});


Vue.component('spinning-target', {
  data: function(){return {};} ,
  template: `<div class="eff-tgt">
    <div style="transform:rotate(0deg);position:absolute;width:100%;height:100%;top:0px;"><div class="eff-tgt2"></div></div>
    <div style="transform:rotate(90deg);position:absolute;width:100%;height:100%;top:0px;"><div class="eff-tgt2"></div></div>
    <div style="transform:rotate(180deg);position:absolute;width:100%;height:100%;top:0px;"><div class="eff-tgt2"></div></div>
    <div style="transform:rotate(270deg);position:absolute;width:100%;height:100%;top:0px;"><div class="eff-tgt2"></div></div>
  </div>`
});

Vue.component('trash-tile', {
  props : ["trash","target"],
  data: function(){return {};} ,
  template: `<div class="my-discarded">
      <div v-for="(item,index) in trash" class="discarded-item tile" v-bind:class="{ 'tile-yoko': item.yoko , 'discarded-tsumogiri' : item.tsumogiri }">
        <img v-bind:src="numtosrc(item.id)">
        <spinning-target v-if="target && ( index + 1 == trash.length )"></spinning-target>
      </div>
    </div>`,
  methods:{
    numtosrc:numtosrc,
    last_target:__last_target
  }
})
Vue.component('pullout-tile', {
  props : ["pullout","target"],
  data: function(){return {};} ,
  template : `
  <div class="pullout-area">
    <div v-if="pullout.length>0" class="pullout-item tile">
        <img v-bind:src="numtosrc(65)" > × #{ pullout.length }
    </div>
  </div>
  `,
  delimiters : ['#{', '}'],
});

Vue.component('exposed-set', {
  props : {"tiles":{default: x=>[] },"type":{default:"chow"},"target":{default:false}},
  data: function(){return {};} ,
  template: `
  <div class="exposed-group">
    <div v-if="type==='pong' || type==='chow' || type==='minkong'" v-for="(item,jndex) in tiles" class="exposed-item tile">
      <img v-bind:src="numtosrc(item)" >
    </div>
    <div v-if=" type==='apkong' " class="apkong-box">
      <div v-for="(item,jndex) in tiles.slice(0,3)">
        <div v-if="jndex === 1" class="kasane-container">
          <div class="kasane">
            <img v-bind:src="numtosrc(tiles[3])" class="tile-yoko" >
          </div>
          <div class="kasane">
            <img v-bind:src="numtosrc(item)" class="tile-yoko" >
          </div>
        </div>
        <span v-else>
          <img v-bind:src="numtosrc(item)" >
        </span>
        <spinning-target v-if="target && ( index + 1 == exposed.length )"></spinning-target>
      </div>
    </div>
    <div v-if=" type==='conckong' " v-for="(item,jndex) in tiles" class="exposed-item tile">
        <span v-if="jndex === 1">
          <img v-bind:src="numtosrc(item)" >
        </span>
        <span v-else>
          <img v-bind:src="numtosrc(0)">
        </span>
    </div>
  </div>
  `,
  methods:{
    numtosrc:numtosrc
  }
});
Vue.component('exposed-tile', {
  props : ["exposed","target"],
  data: function(){return {};} ,
  template: `<div class="exposed-area">
      <exposed-set v-for="(grp,index) in exposed" v-bind:type="grp.type" v-bind:tiles="grp.tiles" v-bind:target="target"></exposed-set>
    </div>`,
  methods:{
    numtosrc:numtosrc,
    last_target:__last_target
  }
})

/*
var sideinfo = new Vue({
  el: '#sideinfo',
  data: (yaku_disp),
  delimiters : ['$${', '}']
})
*/

var root = new Vue({
  el: '#board-root',
  data: deck,
  delimiters : ['$${', '}'],
  methods:{
    numtosrc:numtosrc,
    get_wind_name:get_wind_name
  }
});

var popup = new Vue({
  el: '#meld-select',
  data: meld_selection,
  methods:{
    numtosrc:numtosrc
  }
})


</script>
</body>
</html>
