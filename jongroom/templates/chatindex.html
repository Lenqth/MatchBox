{% load static %}
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title></title>
<meta charset="utf-8">
<meta name="description" content="">
<meta name="author" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="">
<script src="{% static 'jongroom/js/vue.js' %}"></script>
<script src="{% static 'jongroom/js/utils.js' %}"></script>
<!--[if lt IE 9]>
<script src="//cdn.jsdelivr.net/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<script>
socket = new WebSocket("ws://"+location.host+"/jong/room/nyan");

roominfo = { player_slot : [] };
you = -1;


function send_ready(){
  socket.send(JSON.stringify({"ready":roominfo.player_slot[you].ready}));
}
function writeln(x){
  document.getElementById("output").value += x + "\n" ;
}
function send(s){
  var obj={message:s};
  socket.send(JSON.stringify(obj));
}

// loadJSasync(path)

socket.onmessage = function(e) {
  var o = JSON.parse(e.data);
  if("message" in o){
    document.getElementById("sound1").play();
    writeln(o.message);
  }
  console.log(o);
  if("roomsize" in o){
    roominfo.player_slot = (new Array( o.roomsize ).fill(0) ).map( function(){return {"joined":false,"ready":false,"you":false,"name":"none"};} );
  }
  if("position" in o){
    roominfo.player_slot[o.position].you = true;
    you = o.position;
    for(var [i,v] in o.room ){
      roominfo.player_slot[i].joined = true;
    }
  }
  if("room" in o){
    for( var v of o.room ){
      roominfo.player_slot[v.position].joined = true;
      roominfo.player_slot[v.position].ready = v.ready;
    }
  }
  if("joined" in o){
    var dat = o.joined ;
    roominfo.player_slot[dat.position].joined = true;
    roominfo.player_slot[dat.position].ready = dat.ready;
  }
  if("exited" in o){
    var dat = o.exited ;
    roominfo.player_slot[dat.position].joined = false;
  }
  if("set_state" in o){
    var stt = o.set_state;
    var pos = stt.pos;
    delete stt.pos;
    for( var key in stt ){
      roominfo.player_slot[pos][key] = stt[key];
    }
  }
}

socket.onerror = function(e) {console.log("error:",e);}
socket.onclose = function(e) {
  console.log("close:",e);
  writeln("connection closed. please reload later.");
  for(var x of document.getElementsByClassName("group-content") ){
    x.classList.remove("joined");
    x.classList.remove("group-content-you");
  }
}

socket.onopen = function() {
  document.getElementById("sendbutton").onclick=function(e){
    var x = document.getElementById("txbox").value;
    document.getElementById("txbox").value="";
    send(x);
    console.log(x);
  }
}
</script>
<link rel="shortcut icon" href="">
<style>
.flexbox{
  display: flex;

}
.col1{
  width:60%;
}
.col2{

}
#output{
  width:80%;
  height:40%
}
.group-detail{
  display: flex;
  flex-flow: row wrap;
  width:300px;
  height:200px;
  border: 2px blue solid;
}
.group-content{
  box-sizing: border-box;
  flex-basis:50%;
  flex-shrink:1;
  flex-grow: 1;
}

.group-content-you{
  border-width:3px;
  border-style: solid;
  animation: blinkborder 0.7s ease 0.4s infinite alternate;
}

.navbar{
  width:100%;
  height:40px;
  background-color: gray;
  margin: 0px 0px 20px;
  color : white;
}
.login-disp{
  text-align:right;
  margin:10px;
}

@keyframes blinkborder {
  0% {border-color: rgba(255,255,255,1);}
  100% {border-color: rgba(255,255,255,0.2);}
}

.group-content:nth-child(2n) {
  /*flex-basis: 100%;*/
}

.group-content:nth-child(1).joined.ready{background-color: #ffcccc;}
.group-content:nth-child(2).joined.ready{background-color: #ccccff;}
.group-content:nth-child(3).joined.ready{background-color: #ccffcc;}
.group-content:nth-child(4).joined.ready{background-color: #ffccff;}
.group-content:nth-child(1).joined:not(.ready){background-color: #886666;}
.group-content:nth-child(2).joined:not(.ready){background-color: #666688;}
.group-content:nth-child(3).joined:not(.ready){background-color: #668866;}
.group-content:nth-child(4).joined:not(.ready){background-color: #886688;}


</style>
</head>
<body>
<!-- Place your content here -->
<!-- SCRIPTS -->
<!-- Example: <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
<div class="navbar">
  <div class="login-disp">
    {% if user.username == "" %}
      not logined
      <a href="/login">login</a>
    {% else %}
      logined as : {{ user.username }}
      <a href="/logout">logout</a>
    {% endif %}
  </div>
</div>
<audio id="sound1" preload="auto">
  <source src="{% static 'jongroom/sound/puu79_a.wav' %}" type="audio/wav">
</audio>
<div id="loader-root">
</div>
<div id="room-root" class="flexbox">
  <div class="col1">
    <textarea id="output" rows="40"></textarea>
    <input type="text" id="txbox"><input type="button" value="send" id="sendbutton">
  </div>
  <div id="player-list" class="col2">
    <div class="group-detail">
      <div v-for=" (item,index) in player_slot" class="group-content" v-bind:class="{ joined : item.joined , ready : item.ready , 'group-content-you' : item.you }" v-on:click="item.you ? (item.ready=!item.ready,send_ready()) : 0 ;" >
      </div>
    </div>
  </div>
</div>

<script>

var root = new Vue({
  el: '#player-list',
  data: roominfo,
  delimiters : ['$${', '}'],
  methods:{send_ready}
});

</script>

</body>
</html>
